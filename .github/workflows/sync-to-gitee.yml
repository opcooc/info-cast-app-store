name: Sync GitHub Releases to Gitee

on:
  release:
    types: [published] # ÂΩì GitHub Release ÂèëÂ∏ÉÂêéËß¶Âèë

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y curl jq openssh-client

      - name: Configure SSH for Gitee
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      # Ëé∑Âèñ GitHub Release ‰ø°ÊÅØ
      - name: Get GitHub Release info
        id: get_release
        run: |
          echo "Fetching GitHub release info for tag: ${{ github.event.release.tag_name }}"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.event.release.tag_name }}" \
            > release.json

          echo "release_json_path=release.json" >> $GITHUB_OUTPUT

      # ‰∏ãËΩΩÊâÄÊúâÈôÑ‰ª∂Êñá‰ª∂
      - name: Download release assets
        run: |
          mkdir assets
          for url in $(jq -r '.assets[].browser_download_url' release.json); do
            echo "Downloading asset: $url"
            wget -q -P assets "$url"
          done

      # ‰∏ä‰º†Ëá≥ Gitee Release
      - name: Publish Release to Gitee
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          BODY="${{ github.event.release.body }}"
          
          # Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËØ• tag ÁöÑ release
          existing=$(curl -s -H "Content-Type: application/json" \
            -H "Authorization: token ${{ secrets.GITEE_ACCESS_TOKEN }}" \
            "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/tags/${TAG_NAME}")

          if echo "$existing" | grep -q '"id":'; then
            echo "üü° Release already exists on Gitee, updating..."
            release_id=$(echo "$existing" | jq -r '.id')
          else
            echo "üü¢ Creating new release on Gitee..."
            release_id=$(curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${{ secrets.GITEE_ACCESS_TOKEN }}" \
              -d "{\"tag_name\": \"$TAG_NAME\", \"name\": \"$RELEASE_NAME\", \"body\": \"$BODY\", \"prerelease\": false}" \
              "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases" | jq -r '.id')
          fi

          echo "üì¶ Uploading assets to Gitee..."
          for file in assets/*; do
            curl -s -X POST \
              -H "Content-Type: multipart/form-data" \
              -H "Authorization: token ${{ secrets.GITEE_ACCESS_TOKEN }}" \
              -F "access_token=${{ secrets.GITEE_ACCESS_TOKEN }}" \
              -F "file=@${file}" \
              "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/${release_id}/attach_files"
          done
